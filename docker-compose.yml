services:
  opencode:
    image: ghcr.io/fluxbase-eu/opencode-docker:latest
    container_name: opencode
    ports:
      - "${OPENCODE_PORT:-4000}:4000"
    environment:
      # Path to OpenCode config file (mounted below)
      - OPENCODE_CONFIG=/etc/opencode/opencode.json

      # Model configuration (referenced by config file)
      - OPENCODE_MODEL=${OPENCODE_MODEL:-anthropic/claude-sonnet-4-5}
      - OPENCODE_SMALL_MODEL=${OPENCODE_SMALL_MODEL:-anthropic/claude-haiku-4-5}

      # API keys (referenced by config file using {env:VAR_NAME})
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}

      # Optional: Override specific config values with env vars
      # - OPENCODE_AUTOUPDATE=${OPENCODE_AUTOUPDATE:-true}
      # - OPENCODE_SHARE=${OPENCODE_SHARE:-manual}
    volumes:
      # Mount custom config file (see opencode.json.example)
      - ./opencode.json:/etc/opencode/opencode.json:ro

      # Persistent configuration and user preferences
      - opencode-config:/home/opencode/.config/opencode

      # Session storage, cache, and auth credentials
      - opencode-data:/home/opencode/.local/share/opencode

      # Working directory for projects
      - opencode-workspace:/home/opencode/workspace
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  opencode-config:
    driver: local
  opencode-data:
    driver: local
  opencode-workspace:
    driver: local
